<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Date â€” HeyGen Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a; color: #fff; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 20px;
        }
        h1 { font-size: 24px; margin-bottom: 8px; }
        .subtitle { color: #888; font-size: 14px; margin-bottom: 24px; }
        .badge {
            background: #1a1a2e; border: 1px solid #333; padding: 4px 12px;
            border-radius: 20px; font-size: 11px; color: #7c6ef6; margin-bottom: 20px;
        }
        .config { margin-bottom: 20px; text-align: center; }
        .config-row { margin-bottom: 10px; }
        .config label { color: #aaa; font-size: 13px; margin-right: 8px; }
        .config select {
            background: #1a1a1a; border: 1px solid #333; color: #fff;
            padding: 8px 12px; border-radius: 8px; font-size: 13px; width: 340px;
        }
        #start-btn {
            background: linear-gradient(135deg, #7c6ef6, #a855f7);
            border: none; color: #fff; font-size: 18px; font-weight: 600;
            padding: 16px 48px; border-radius: 50px; cursor: pointer;
            transition: transform 0.2s; margin-bottom: 16px;
        }
        #start-btn:hover { transform: scale(1.05); }
        #start-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        #status { color: #aaa; font-size: 14px; margin-bottom: 16px; min-height: 20px; text-align: center; }
        #error-log { color: #f66; font-size: 12px; margin-top: 8px; max-width: 500px; text-align: center; word-break: break-all; }
        #video-container {
            width: 100%; max-width: 480px; background: #111;
            border-radius: 16px; overflow: hidden; display: none; position: relative;
        }
        #avatar-video { width: 100%; display: block; }
        .controls {
            display: none; gap: 12px; margin-top: 16px; align-items: center;
            flex-wrap: wrap; justify-content: center;
        }
        .controls button {
            background: #222; border: 1px solid #444; color: #fff;
            padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px;
        }
        .controls button:hover { background: #333; }
        .end-btn:hover { background: #ff4444 !important; border-color: #ff4444 !important; }
        #chat-input {
            background: #1a1a1a; border: 1px solid #333; color: #fff;
            padding: 10px 16px; border-radius: 25px; font-size: 14px; width: 260px;
        }
        .indicator {
            position: absolute; top: 12px; left: 12px; display: flex; align-items: center; gap: 6px;
            background: rgba(0,0,0,0.7); padding: 6px 12px; border-radius: 8px; font-size: 12px; z-index: 10;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #666; display: inline-block; }
        .dot.live { background: #0f0; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
        .tip { max-width: 500px; text-align: center; color: #555; font-size: 12px; margin-top: 16px; line-height: 1.5; }
    </style>
</head>
<body>
    <h1>ðŸŽ¥ AI Video Date â€” HeyGen</h1>
    <p class="subtitle">Real-time conversation with an AI avatar</p>
    <div class="badge">Powered by HeyGen Interactive Avatar + GPT-4o</div>

    <div class="config">
        <div class="config-row">
            <label>Avatar:</label>
            <select id="avatar-select">
                <option value="">ðŸ¤– Default Avatar</option>
                <option value="d8b3833adc7f4aedbb86b284bf1f9eb1">ðŸ“¸ Amanda's Photo</option>
            </select>
        </div>
    </div>

    <button id="start-btn">Start Video Date ðŸ’•</button>
    <div id="status">Ready â€” tap Start to begin</div>
    <div id="error-log"></div>

    <div id="video-container">
        <div class="indicator"><div class="dot live" id="dot"></div> <span id="state">Live</span></div>
        <video id="avatar-video" autoplay playsinline muted></video>
    </div>

    <div class="controls" id="controls">
        <input type="text" id="chat-input" placeholder="Type something to say...">
        <button id="send-btn">Send ðŸ’¬</button>
        <button id="voice-btn">ðŸŽ™ Start Voice</button>
        <button class="end-btn" id="end-btn">End Date âœ‹</button>
    </div>

    <p class="tip">Type a message and hit Send â€” the avatar will respond with AI.<br>Or tap "Start Voice" for hands-free conversation.</p>

    <!-- Load SDK dependencies first -->
    <script>
        // Fallback: if ES module import fails, show a clear error
        window.onerror = function(msg, url, line) {
            document.getElementById('error-log').textContent = 'JS Error: ' + msg;
            return false;
        };
    </script>

    <script type="module">
        // ---- SDK Import ----
        let StreamingAvatar, TaskType, StreamingEvents, AvatarQuality, VoiceEmotion;
        try {
            const mod = await import('https://esm.sh/@heygen/streaming-avatar@2');
            StreamingAvatar = mod.StreamingAvatar || mod.default;
            TaskType = mod.TaskType;
            StreamingEvents = mod.StreamingEvents;
            AvatarQuality = mod.AvatarQuality;
            VoiceEmotion = mod.VoiceEmotion;
            console.log('âœ… HeyGen SDK loaded', Object.keys(mod));
        } catch (e) {
            document.getElementById('status').textContent = 'âŒ SDK failed to load';
            document.getElementById('error-log').textContent = e.message;
            console.error('SDK load error:', e);
            throw e;
        }

        // ---- Config ----
        const API_KEY = 'sk_V2_hgu_kiKFJG7KJov_9vvKkvT4fFbndbtZvT7kliw6GsHzeEuS';
        const DATE_PROMPT = `You are a fun, charming person on a first video date named Alex. Be warm, curious, flirty. Ask fun questions. Keep responses SHORT (2-3 sentences). React to what they say. Never mention you're AI. Start by introducing yourself.`;

        // ---- State ----
        let avatar = null;
        let voiceActive = false;

        // ---- Elements ----
        const $ = id => document.getElementById(id);
        const statusEl = $('status');
        const errorEl = $('error-log');

        function log(msg) { statusEl.textContent = msg; console.log('[heygen]', msg); }

        // ---- Mark SDK loaded ----
        log('âœ… Ready â€” tap Start to begin');

        // ---- Start ----
        $('start-btn').addEventListener('click', async () => {
            $('start-btn').disabled = true;
            errorEl.textContent = '';

            try {
                log('ðŸ”„ Getting token...');
                const tokenRes = await fetch('https://api.heygen.com/v1/streaming.create_token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': API_KEY }
                });
                const tokenData = await tokenRes.json();
                console.log('Token:', tokenData);
                if (tokenData.error) throw new Error('Token error: ' + tokenData.error);
                const token = tokenData.data?.token;
                if (!token) throw new Error('No token returned');

                log('ðŸŽ­ Creating avatar session...');
                avatar = new StreamingAvatar({ token });

                avatar.on(StreamingEvents.STREAM_READY, (evt) => {
                    console.log('STREAM_READY', evt);
                    log('âœ… Connected! Type a message or start voice ðŸ‘‹');
                    const mediaStream = evt.detail;
                    if (mediaStream) {
                        const vid = $('avatar-video');
                        vid.srcObject = mediaStream;
                        vid.muted = false;
                        vid.play().catch(e => console.warn('play():', e));
                    }
                    $('video-container').style.display = 'block';
                    $('controls').style.display = 'flex';
                });

                avatar.on(StreamingEvents.AVATAR_START_TALKING, () => { $('state').textContent = 'Speaking...'; });
                avatar.on(StreamingEvents.AVATAR_STOP_TALKING, () => { $('state').textContent = 'Listening...'; });
                avatar.on(StreamingEvents.STREAM_DISCONNECTED, () => { log('Disconnected'); });

                const avatarId = $('avatar-select').value || undefined;

                log('ðŸ“ž Starting stream...');
                const session = await avatar.createStartAvatar({
                    avatarName: avatarId,
                    quality: AvatarQuality.High,
                    knowledgeBase: DATE_PROMPT,
                    voice: { emotion: VoiceEmotion.FRIENDLY },
                    language: 'en',
                });
                console.log('Session:', session);
                log('â³ Waiting for stream...');

            } catch (err) {
                log('âŒ Error');
                errorEl.textContent = err.message || String(err);
                $('start-btn').disabled = false;
                console.error('Start error:', err);
            }
        });

        // ---- Send text ----
        $('send-btn').addEventListener('click', async () => {
            if (!avatar) return;
            const text = $('chat-input').value.trim();
            if (!text) return;
            $('chat-input').value = '';
            log('ðŸ’¬ Sending: ' + text.substring(0, 40) + '...');
            try {
                await avatar.speak({ text, task_type: TaskType.TALK });
            } catch (e) { errorEl.textContent = e.message; }
        });
        $('chat-input').addEventListener('keypress', e => { if (e.key === 'Enter') $('send-btn').click(); });

        // ---- Voice ----
        $('voice-btn').addEventListener('click', async () => {
            if (!avatar) return;
            try {
                if (!voiceActive) {
                    await avatar.startVoiceChat({ useSilencePrompt: true });
                    voiceActive = true;
                    $('voice-btn').textContent = 'ðŸ”‡ Stop Voice';
                    log('ðŸŽ™ Voice active â€” just talk!');
                } else {
                    await avatar.closeVoiceChat();
                    voiceActive = false;
                    $('voice-btn').textContent = 'ðŸŽ™ Start Voice';
                    log('Voice stopped');
                }
            } catch (e) { errorEl.textContent = e.message; }
        });

        // ---- End ----
        $('end-btn').addEventListener('click', async () => {
            if (avatar) { try { await avatar.stopAvatar(); } catch(e){} avatar = null; }
            $('video-container').style.display = 'none';
            $('controls').style.display = 'none';
            $('start-btn').disabled = false;
            voiceActive = false;
            $('voice-btn').textContent = 'ðŸŽ™ Start Voice';
            log('ðŸ“± Date ended!');
        });
    </script>
</body>
</html>
